<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile-Responsive Object Recognition Web App (YOLOv5)</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            transition: background-color 0.3s, color 0.3s;
            margin: 0;
            box-sizing: border-box;
        }
        body.dark-mode {
            background-color: #333;
            color: #fff;
        }
        #video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin-bottom: 20px;
        }
        #video {
            width: 100%;
            height: auto;
            display: block;
        }
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #status, #object-count, #controls, #fps {
            margin-bottom: 10px;
            width: 100%;
            max-width: 640px;
            text-align: center;
        }
        button, select {
            margin: 5px;
            padding: 5px 10px;
        }
        @media (max-width: 640px) {
            body {
                padding: 5px;
            }
            h1 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <h1>Mobile-Responsive Object Recognition (YOLOv5)</h1>
    <div id="status">Loading model...</div>
    <div id="controls">
        <select id="camera-select">
            <option value="">Select Camera</option>
        </select>
        <button id="dark-mode-toggle">Toggle Dark Mode</button>
        <button id="start-camera">Start Camera</button>
    </div>
    <div id="video-container">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="canvas"></canvas>
    </div>
    <div id="fps">FPS: 0</div>
    <div id="object-count"></div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusDiv = document.getElementById('status');
        const cameraSelect = document.getElementById('camera-select');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const objectCountDiv = document.getElementById('object-count');
        const fpsDiv = document.getElementById('fps');
        const startCameraButton = document.getElementById('start-camera');

        let model;
        let stream;
        let objectCounts = {};
        let lastFrameTime = 0;
        let frameCount = 0;
        let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

        // YOLOv5 class names (COCO dataset)
        const classNames = ['person', 'bicycle', 'car', 'motorcycle', 'airplane', 'bus', 'train', 'truck', 'boat', 'traffic light', 'fire hydrant', 'stop sign', 'parking meter', 'bench', 'bird', 'cat', 'dog', 'horse', 'sheep', 'cow', 'elephant', 'bear', 'zebra', 'giraffe', 'backpack', 'umbrella', 'handbag', 'tie', 'suitcase', 'frisbee', 'skis', 'snowboard', 'sports ball', 'kite', 'baseball bat', 'baseball glove', 'skateboard', 'surfboard', 'tennis racket', 'bottle', 'wine glass', 'cup', 'fork', 'knife', 'spoon', 'bowl', 'banana', 'apple', 'sandwich', 'orange', 'broccoli', 'carrot', 'hot dog', 'pizza', 'donut', 'cake', 'chair', 'couch', 'potted plant', 'bed', 'dining table', 'toilet', 'tv', 'laptop', 'mouse', 'remote', 'keyboard', 'cell phone', 'microwave', 'oven', 'toaster', 'sink', 'refrigerator', 'book', 'clock', 'vase', 'scissors', 'teddy bear', 'hair drier', 'toothbrush'];

        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
        });

        // Load YOLOv5 model
        async function loadModel() {
            statusDiv.textContent = 'Loading YOLOv5 model...';
            model = await tf.loadGraphModel('https://cdn.jsdelivr.net/npm/@tensorflow-models/yolov5@1.6.2/dist/web_model/model.json');
            statusDiv.textContent = 'Model loaded. Setting up camera...';
            setupCameras();
        }

        loadModel();

        function setupCameras() {
            navigator.mediaDevices.enumerateDevices()
                .then(devices => {
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    videoDevices.forEach((device, index) => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.text = device.label || `Camera ${index + 1}`;
                        cameraSelect.appendChild(option);
                    });

                    if (videoDevices.length === 1) {
                        cameraSelect.value = videoDevices[0].deviceId;
                        if (!isIOS) {
                            startCamera();
                        }
                    } else {
                        cameraSelect.addEventListener('change', startCamera);
                    }

                    if (isIOS) {
                        startCameraButton.style.display = 'inline-block';
                        startCameraButton.addEventListener('click', startCamera);
                    } else {
                        startCameraButton.style.display = 'none';
                    }
                })
                .catch(err => {
                    console.error('Error enumerating devices:', err);
                    statusDiv.textContent = 'Error setting up cameras. Please refresh and try again.';
                });
        }

        function startCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: { 
                    deviceId: cameraSelect.value ? { exact: cameraSelect.value } : undefined,
                    facingMode: 'environment'
                }
            };

            navigator.mediaDevices.getUserMedia(constraints)
                .then(newStream => {
                    stream = newStream;
                    video.srcObject = stream;
                    video.play();
                    video.onloadedmetadata = () => {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        statusDiv.textContent = 'Camera accessed. Detecting objects...';
                        detectObjects();
                    };
                })
                .catch(err => {
                    console.error('Error accessing the camera:', err);
                    statusDiv.textContent = 'Error accessing the camera. Please make sure you have given permission.';
                });
        }

        async function detectObjects(timestamp) {
            frameCount++;
            if (timestamp - lastFrameTime >= 1000) {
                fpsDiv.textContent = `FPS: ${frameCount}`;
                frameCount = 0;
                lastFrameTime = timestamp;
            }

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const tfImg = tf.browser.fromPixels(video);
                const expandedImg = tfImg.expandDims();
                const resizedImg = tf.image.resizeBilinear(expandedImg, [640, 640]);
                const normalizedImg = resizedImg.div(255.0);

                const predictions = await model.executeAsync(normalizedImg);
                const boxes = await predictions[0].array();
                const scores = await predictions[1].array();
                const classes = await predictions[2].array();

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                objectCounts = {};

                for (let i = 0; i < boxes[0].length; i++) {
                    if (scores[0][i] > 0.5) {
                        const [y, x, height, width] = boxes[0][i];
                        const class_id = classes[0][i];

                        const color = '#' + Math.floor(Math.random()*16777215).toString(16);
                        ctx.strokeStyle = color;
                        ctx.lineWidth = 2;
                        ctx.strokeRect(
                            x * canvas.width, 
                            y * canvas.height, 
                            width * canvas.width, 
                            height * canvas.height
                        );

                        ctx.fillStyle = color;
                        ctx.font = '16px Arial';
                        ctx.fillText(
                            `${classNames[class_id]} (${Math.round(scores[0][i] * 100)}%)`, 
                            x * canvas.width, 
                            y * canvas.height > 10 ? y * canvas.height - 5 : 10
                        );

                        objectCounts[classNames[class_id]] = (objectCounts[classNames[class_id]] || 0) + 1;
                    }
                }

                let countText = 'Object Counts: ';
                for (let [object, count] of Object.entries(objectCounts)) {
                    countText += `${object}: ${count}, `;
                }
                objectCountDiv.textContent = countText.slice(0, -2);

                tf.dispose([tfImg, expandedImg, resizedImg, normalizedImg, ...predictions]);
            }

            requestAnimationFrame(detectObjects);
        }
    </script>
</body>
</html>